{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "ARM Template",
      "version": "1.0.0.0",
      "templateHash": "36PowerShellServicesOnAKS-NoMonitoring"
    }
  },
  "parameters": {
    "clusterName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 63,
      "metadata": {
        "description": "The name of the AKS cluster. Must be between 1 and 63 characters, contain only letters, numbers, underscores, and hyphens."
      }
    },
    "dnsPrefix": {
      "type": "string",
      "minLength": 1,
      "maxLength": 54,
      "metadata": {
        "description": "DNS prefix for the cluster. Must be unique within Azure."
      }
    },
    "nodeCount": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 1,
      "maxValue": 3,
      "metadata": {
        "description": "The number of nodes for the cluster (1-3 for developer tier)."
      }
    },
    "nodeVMSize": {
      "type": "string",
      "defaultValue": "Standard_B2s",
      "allowedValues": [
        "Standard_B2s",
        "Standard_B2ms",
        "Standard_D2s_v3"
      ],
      "metadata": {
        "description": "The VM size of the agent nodes (developer tier sizes)."
      }
    },
    "kubernetesVersion": {
      "type": "string",
      "defaultValue": "1.34.1",
      "metadata": {
        "description": "The version of Kubernetes."
      }
    },
    "containerRegistryName": {
      "type": "string",
      "minLength": 5,
      "maxLength": 50,
      "metadata": {
        "description": "The name of the Azure Container Registry. Must be globally unique, 5-50 characters, and contain only lowercase letters and numbers."
      }
    },
    "enableAutoScaling": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable auto-scaling for the node pool (not recommended for developer tier)."
      }
    },
    "maxNodeCount": {
      "type": "int",
      "defaultValue": 3,
      "minValue": 1,
      "maxValue": 5,
      "metadata": {
        "description": "Maximum number of nodes for auto-scaling."
      }
    },
    "minNodeCount": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 1,
      "maxValue": 3,
      "metadata": {
        "description": "Minimum number of nodes for auto-scaling."
      }
    },
    "networkPlugin": {
      "type": "string",
      "defaultValue": "kubenet",
      "allowedValues": [
        "kubenet",
        "azure"
      ],
      "metadata": {
        "description": "Network plugin used for building the Kubernetes network (kubenet is more cost-effective)."
      }
    }
  },
  "variables": {
    "location": "[resourceGroup().location]",
    "acrSku": "Basic"
  },
  "resources": [
    {
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2023-01-01-preview",
      "name": "[parameters('containerRegistryName')]",
      "location": "[variables('location')]",
      "sku": {
        "name": "[variables('acrSku')]"
      },
      "properties": {
        "adminUserEnabled": false,
        "publicNetworkAccess": "Enabled",
        "zoneRedundancy": "Disabled",
        "policies": {
          "quarantinePolicy": {
            "status": "disabled"
          },
          "trustPolicy": {
            "type": "Notary",
            "status": "disabled"
          },
          "retentionPolicy": {
            "days": 7,
            "status": "disabled"
          }
        }
      }
    },
    {
      "type": "Microsoft.ContainerService/managedClusters",
      "apiVersion": "2023-10-01",
      "name": "[parameters('clusterName')]",
      "location": "[variables('location')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "dnsPrefix": "[parameters('dnsPrefix')]",
        "kubernetesVersion": "[parameters('kubernetesVersion')]",
        "enableRBAC": true,
        "agentPoolProfiles": [
          {
            "name": "agentpool",
            "count": "[parameters('nodeCount')]",
            "vmSize": "[parameters('nodeVMSize')]",
            "osType": "Linux",
            "osDiskSizeGB": 30,
            "osDiskType": "Managed",
            "type": "VirtualMachineScaleSets",
            "mode": "System",
            "enableAutoScaling": "[parameters('enableAutoScaling')]",
            "minCount": "[if(parameters('enableAutoScaling'), parameters('minNodeCount'), json('null'))]",
            "maxCount": "[if(parameters('enableAutoScaling'), parameters('maxNodeCount'), json('null'))]",
            "maxPods": 30,
            "enableNodePublicIP": false
          }
        ],
        "networkProfile": {
          "networkPlugin": "[parameters('networkPlugin')]",
          "loadBalancerSku": "standard",
          "serviceCidr": "10.0.0.0/16",
          "dnsServiceIP": "10.0.0.10"
        },
        "apiServerAccessProfile": {
          "enablePrivateCluster": false
        },
        "autoUpgradeProfile": {
          "upgradeChannel": "patch"
        },
        "disableLocalAccounts": false
      }
    }
  ],
  "outputs": {
    "clusterName": {
      "type": "string",
      "value": "[parameters('clusterName')]"
    },
    "clusterFQDN": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName'))).fqdn]"
    },
    "containerRegistryName": {
      "type": "string",
      "value": "[parameters('containerRegistryName')]"
    },
    "containerRegistryLoginServer": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName'))).loginServer]"
    },
    "aksIdentityPrincipalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName')), '2023-10-01', 'Full').identity.principalId]"
    },
    "acrId": {
      "type": "string",
      "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName'))]"
    },
    "getCredentialsCommand": {
      "type": "string",
      "value": "[format('az aks get-credentials --resource-group {0} --name {1}', resourceGroup().name, parameters('clusterName'))]"
    },
    "attachAcrCommand": {
      "type": "string",
      "value": "[format('az aks update --resource-group {0} --name {1} --attach-acr {2}', resourceGroup().name, parameters('clusterName'), parameters('containerRegistryName'))]"
    },
    "enableMonitoringCommand": {
      "type": "string",
      "value": "[format('az aks enable-addons --resource-group {0} --name {1} --addons monitoring', resourceGroup().name, parameters('clusterName'))]"
    },
    "postDeploymentInstructions": {
      "type": "string",
      "value": "Cluster deployed without monitoring. After deployment: 1) Attach ACR using 'attachAcrCommand', 2) Get credentials using 'getCredentialsCommand', 3) Optionally enable monitoring using 'enableMonitoringCommand'. See README.md for details."
    }
  }
}



