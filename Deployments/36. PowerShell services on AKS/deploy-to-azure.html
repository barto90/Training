<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deploy PowerShell Services on AKS</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
            color: #333;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1, h2 {
            color: #2c3e50;
        }
        h1 {
            background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            border-bottom: 3px solid #0078d4;
            padding-bottom: 10px;
            text-align: center;
        }
        .deploy-button {
            display: inline-block;
            background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
            color: white;
            padding: 15px 30px;
            text-align: center;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            margin: 20px 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 120, 212, 0.4);
        }
        .deploy-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 120, 212, 0.6);
        }
        .deploy-button img {
            vertical-align: middle;
        }
        pre {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border-left: 4px solid #0078d4;
            font-size: 14px;
        }
        .note {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        .warning {
            background: linear-gradient(135deg, #fff3e0 0%, #ffcc02 20%);
            border-left: 4px solid #ff9800;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        .success {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-left: 4px solid #4caf50;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        .critical {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left: 4px solid #f44336;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        .feature-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #0078d4;
            transition: transform 0.3s ease;
        }
        .feature-item:hover {
            transform: translateY(-5px);
        }
        code {
            background-color: #f1f3f4;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .step {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-left: 4px solid #9c27b0;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        .cost-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #4caf50;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .cost-box h3 {
            color: #2e7d32;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ò∏Ô∏è PowerShell Services on AKS</h1>
        
        <p>Deploy a <strong>developer-tier</strong> Azure Kubernetes Service (AKS) cluster optimized for hosting PowerShell-based containerized services. This cost-effective solution is perfect for development and testing.</p>
        
        <div class="feature-list">
            <div class="feature-item">
                <strong>‚ò∏Ô∏è AKS Cluster</strong><br>
                Developer-tier Kubernetes with 1-3 nodes
            </div>
            <div class="feature-item">
                <strong>üì¶ Container Registry</strong><br>
                Private Docker registry (Basic tier)
            </div>
            <div class="feature-item">
                <strong>üê≥ PowerShell Containers</strong><br>
                Run PowerShell 7.4 services in Kubernetes
            </div>
            <div class="feature-item">
                <strong>üîë Managed Identity</strong><br>
                Secure authentication without credentials
            </div>
            <div class="feature-item">
                <strong>üìä Log Analytics</strong><br>
                Optional monitoring (enable after deployment)
            </div>
            <div class="feature-item">
                <strong>üîí Security</strong><br>
                Defender for Containers enabled
            </div>
            <div class="feature-item">
                <strong>‚ö° Auto-Scaling</strong><br>
                Optional horizontal pod autoscaling
            </div>
            <div class="feature-item">
                <strong>üåê HTTP Routing</strong><br>
                Simple ingress for testing
            </div>
            <div class="feature-item">
                <strong>üí∞ Cost-Effective</strong><br>
                ~$40-50/month for dev/test workloads
            </div>
        </div>

        <div class="cost-box">
            <h3>üí∞ Estimated Monthly Cost</h3>
            <table>
                <tr>
                    <th>Component</th>
                    <th>Configuration</th>
                    <th>Est. Cost/Month</th>
                </tr>
                <tr>
                    <td>AKS Control Plane</td>
                    <td>Free tier</td>
                    <td><strong>$0</strong></td>
                </tr>
                <tr>
                    <td>Compute (1x B2s Node)</td>
                    <td>2 vCPU, 4GB RAM</td>
                    <td>~$30</td>
                </tr>
                <tr>
                    <td>Container Registry</td>
                    <td>Basic tier</td>
                    <td>~$5</td>
                </tr>
                <tr>
                    <td>Log Analytics (Optional)</td>
                    <td>30-day retention</td>
                    <td>~$10 (if enabled)</td>
                </tr>
                <tr>
                    <td>Networking</td>
                    <td>Standard egress</td>
                    <td>~$5</td>
                </tr>
                <tr>
                    <th colspan="2"><strong>Total (without monitoring)</strong></th>
                    <th><strong>~$40/month</strong></th>
                </tr>
                <tr>
                    <td colspan="2"><em>With monitoring enabled:</em></td>
                    <td><em>~$50/month</em></td>
                </tr>
            </table>
        </div>

        <h2>üöÄ Deploy to Azure</h2>
        <p>Click the button below to deploy this AKS cluster to your Azure subscription:</p>
        
        <a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fbarto90%2FTraining%2Fmain%2FDeployments%2F36.%20PowerShell%20services%20on%20AKS%2Fazuredeploy-no-monitoring.json" target="_blank" class="deploy-button">
            <img src="https://aka.ms/deploytoazurebutton" alt="Deploy to Azure">
        </a>

        <div class="note">
            <strong>üí° Note:</strong> The deployment creates the AKS cluster and container registry (monitoring can be enabled later). After deployment, you'll need to attach ACR to AKS and deploy your PowerShell containers. To enable monitoring after deployment, use: <code>az aks enable-addons --addons monitoring</code>
        </div>

        <h2>üìã Required Parameters</h2>
        <table>
            <tr>
                <th>Parameter</th>
                <th>Description</th>
                <th>Example</th>
            </tr>
            <tr>
                <td><code>clusterName</code></td>
                <td>Name for the AKS cluster</td>
                <td>myaks-dev</td>
            </tr>
            <tr>
                <td><code>dnsPrefix</code></td>
                <td>DNS prefix (must be unique)</td>
                <td>myaks-dev</td>
            </tr>
            <tr>
                <td><code>containerRegistryName</code></td>
                <td>Name for Azure Container Registry</td>
                <td>myacrdev123</td>
            </tr>
            <tr>
                <td><code>nodeCount</code></td>
                <td>Number of nodes (1-3)</td>
                <td>1</td>
            </tr>
            <tr>
                <td><code>nodeVMSize</code></td>
                <td>VM size for nodes</td>
                <td>Standard_B2s</td>
            </tr>
            <tr>
                <td><code>kubernetesVersion</code></td>
                <td>Kubernetes version</td>
                <td>1.28.5</td>
            </tr>
            <tr>
                <td><code>enableAutoScaling</code></td>
                <td>Enable auto-scaling (optional)</td>
                <td>false</td>
            </tr>
            <tr>
                <td><code>networkPlugin</code></td>
                <td>Network plugin (kubenet/azure)</td>
                <td>kubenet</td>
            </tr>
        </table>

        <h2>üõ†Ô∏è Post-Deployment Setup</h2>
        
        <div class="critical">
            <h3>‚ö†Ô∏è CRITICAL STEPS: Complete After Deployment</h3>
            <p>These steps are required before you can deploy containers to the cluster.</p>
        </div>

        <div class="step">
            <h3>Step 1: Attach ACR to AKS</h3>
            <p>Grant the AKS cluster permission to pull images from Azure Container Registry:</p>
            <pre><code># Using Azure CLI
RESOURCE_GROUP="myResourceGroup"
AKS_NAME="myaks-dev"
ACR_NAME="myacrdev123"

az aks update \
  --resource-group $RESOURCE_GROUP \
  --name $AKS_NAME \
  --attach-acr $ACR_NAME</code></pre>
            <p>Or use the <code>attachAcrCommand</code> from deployment outputs.</p>
        </div>

        <div class="step">
            <h3>Step 2: Get AKS Credentials</h3>
            <p>Configure kubectl to connect to your cluster:</p>
            <pre><code>az aks get-credentials \
  --resource-group $RESOURCE_GROUP \
  --name $AKS_NAME \
  --overwrite-existing

# Verify connection
kubectl get nodes
kubectl get pods --all-namespaces</code></pre>
        </div>

        <div class="step">
            <h3>Step 3: Build PowerShell Container</h3>
            <p>Create a Dockerfile for your PowerShell service:</p>
            <pre><code>FROM mcr.microsoft.com/powershell:7.4-ubuntu-22.04

WORKDIR /app
COPY ./app /app

# Install Pode web framework
RUN pwsh -Command "Install-Module -Name Pode -Force -Scope AllUsers"

EXPOSE 8080
CMD ["pwsh", "-File", "/app/server.ps1"]</code></pre>
        </div>

        <div class="step">
            <h3>Step 4: Build and Push Image</h3>
            <p>Build your container and push to ACR:</p>
            <pre><code># Build image
docker build -t $ACR_NAME.azurecr.io/powershell-service:v1 .

# Login to ACR
az acr login --name $ACR_NAME

# Push image
docker push $ACR_NAME.azurecr.io/powershell-service:v1</code></pre>
        </div>

        <div class="step">
            <h3>Step 5: Deploy to Kubernetes</h3>
            <p>Create a deployment manifest and apply it:</p>
            <pre><code>kubectl apply -f deployment.yaml
kubectl get pods -w
kubectl get service powershell-service</code></pre>
            <p>See the README.md for complete deployment manifests and examples.</p>
        </div>

        <div class="success">
            <h3>üéØ Testing Your PowerShell Service</h3>
            <p>After deployment:</p>
            <ol>
                <li>Get the external IP: <code>kubectl get service powershell-service</code></li>
                <li>Test the health endpoint: <code>curl http://[EXTERNAL_IP]/health</code></li>
                <li>View logs: <code>kubectl logs -l app=powershell-service</code></li>
                <li>Monitor in Azure Portal: AKS ‚Üí Monitoring ‚Üí Insights</li>
            </ol>
        </div>

        <h2>üê≥ Sample PowerShell Web Service</h2>
        <div class="note">
            <p>Example PowerShell service using the Pode framework:</p>
            <pre><code>Import-Module Pode

Start-PodeServer {
    Add-PodeEndpoint -Address * -Port 8080 -Protocol Http
    
    # Health check
    Add-PodeRoute -Method Get -Path '/health' -ScriptBlock {
        Write-PodeJsonResponse -Value @{
            status = "healthy"
            timestamp = (Get-Date).ToString("o")
        }
    }
    
    # API endpoint
    Add-PodeRoute -Method Get -Path '/api/info' -ScriptBlock {
        Write-PodeJsonResponse -Value @{
            message = "Hello from PowerShell on AKS!"
            hostname = $env:HOSTNAME
            psVersion = $PSVersionTable.PSVersion.ToString()
        }
    }
}</code></pre>
        </div>

        <h2>üìä Monitoring and Management</h2>
        <div class="note">
            <p><strong>Enable Monitoring (Optional):</strong> After deployment, enable Container Insights with:</p>
            <pre><code>az aks enable-addons --resource-group myResourceGroup --name myaks-dev --addons monitoring</code></pre>
            <p><strong>Container Insights:</strong> View metrics in Azure Portal ‚Üí AKS ‚Üí Monitoring ‚Üí Insights (after enabling)</p>
            <p><strong>Log Analytics:</strong> Query container logs and metrics using KQL (after enabling)</p>
            <p><strong>kubectl Commands:</strong></p>
            <pre><code># View all resources
kubectl get all

# View pod logs
kubectl logs -f &lt;pod-name&gt;

# Execute commands in pod
kubectl exec -it &lt;pod-name&gt; -- pwsh

# Scale deployment
kubectl scale deployment powershell-service --replicas=3</code></pre>
        </div>

        <h2>üîí Security Best Practices</h2>
        <div class="warning">
            <h3>‚ö†Ô∏è Production Considerations</h3>
            <p>This is a <strong>developer tier</strong> deployment. For production:</p>
            <ul>
                <li><strong>Use Private Cluster:</strong> Enable private endpoint for API server</li>
                <li><strong>Network Policies:</strong> Implement pod-to-pod network restrictions</li>
                <li><strong>Azure AD Integration:</strong> Use Azure AD for RBAC authentication</li>
                <li><strong>Pod Security:</strong> Implement Pod Security Standards</li>
                <li><strong>Secrets Management:</strong> Use Azure Key Vault CSI driver</li>
                <li><strong>Image Scanning:</strong> Enable vulnerability scanning in ACR</li>
                <li><strong>Larger Nodes:</strong> Use D-series or higher for production workloads</li>
                <li><strong>Multiple Node Pools:</strong> Separate system and user workloads</li>
                <li><strong>Availability Zones:</strong> Enable zone redundancy</li>
            </ul>
        </div>

        <h2>üí° Use Cases</h2>
        <div class="success">
            <p>PowerShell services on AKS are ideal for:</p>
            <ul>
                <li><strong>Azure Management APIs:</strong> REST APIs for Azure resource management</li>
                <li><strong>Data Processing:</strong> ETL pipelines and data transformation</li>
                <li><strong>Automation Services:</strong> Scheduled jobs and workflows</li>
                <li><strong>Integration Services:</strong> Connect different systems and APIs</li>
                <li><strong>DevOps Tools:</strong> Custom deployment and monitoring tools</li>
                <li><strong>Legacy Migration:</strong> Containerize existing PowerShell scripts</li>
            </ul>
        </div>

        <h2>üîß Troubleshooting</h2>
        <div class="step">
            <h3>Common Issues and Solutions</h3>
            <p><strong>Issue: Cannot pull image from ACR</strong></p>
            <ul>
                <li>Verify ACR attachment: <code>az aks show --resource-group RG --name CLUSTER --query identityProfile</code></li>
                <li>Re-attach ACR: <code>az aks update --attach-acr ACR_NAME</code></li>
            </ul>
            
            <p><strong>Issue: Pods not starting</strong></p>
            <ul>
                <li>Check pod status: <code>kubectl describe pod [POD_NAME]</code></li>
                <li>View logs: <code>kubectl logs [POD_NAME]</code></li>
                <li>Check resource constraints: <code>kubectl top nodes</code></li>
            </ul>
            
            <p><strong>Issue: Service not accessible</strong></p>
            <ul>
                <li>Wait for LoadBalancer (2-5 minutes)</li>
                <li>Check service: <code>kubectl get svc -o wide</code></li>
                <li>Verify pod is running: <code>kubectl get pods</code></li>
            </ul>
        </div>

        <h2>üìö Additional Resources</h2>
        <div class="note">
            <ul>
                <li><a href="https://docs.microsoft.com/azure/aks/" target="_blank">AKS Documentation</a></li>
                <li><a href="https://docs.microsoft.com/powershell/scripting/install/powershell-in-docker" target="_blank">PowerShell in Containers</a></li>
                <li><a href="https://badgerati.github.io/Pode/" target="_blank">Pode Web Framework</a></li>
                <li><a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/" target="_blank">kubectl Cheat Sheet</a></li>
                <li><a href="https://docs.microsoft.com/azure/container-registry/" target="_blank">Azure Container Registry</a></li>
            </ul>
        </div>
    </div>
</body>
</html>



